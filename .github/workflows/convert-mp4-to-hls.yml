name: Convert MP4 to HLS

on:
  workflow_dispatch:
    inputs:
      url:
        required: true
        description: "Public MP4 URL from R2"
      keyprefix:
        required: true
        description: "Where to upload the HLS output in R2 (e.g. lectures/2025/myvideo-hls)"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Download MP4
        run: |
          curl -L "${{ github.event.inputs.url }}" -o input.mp4

      - name: üß™ Convert MP4 to HLS (.m3u8)
        run: |
          mkdir output
          ffmpeg -i input.mp4 -preset veryfast \
            -vf "scale=w=1280:h=-2" \
            -c:a aac -b:a 128k \
            -c:v h264 -profile:v main -crf 20 -g 48 -keyint_min 48 \
            -sc_threshold 0 -b:v 2000k -maxrate 2000k -bufsize 4000k \
            -f hls \
            -hls_time 6 -hls_playlist_type vod \
            -hls_segment_filename "output/segment_%03d.ts" \
            output/index.m3u8

      - name: üì§ Upload to R2
        env:
          BUCKET_UPLOAD_URL: https://upload-video.essyritesh.workers.dev
        run: |
          for file in output/*; do
            filename=$(basename "$file")
            curl -X POST \
              -H "Content-Type: $(file --mime-type -b "$file")" \
              --data-binary "@$file" \
              "${BUCKET_UPLOAD_URL}?key=${{ github.event.inputs.keyprefix }}/$filename"
            echo "‚úÖ Uploaded: $filename"
          done
